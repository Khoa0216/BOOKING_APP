-- 1. NGƯỜI DÙNG
CREATE TABLE NGUOIDUNG (
    ID NUMBER PRIMARY KEY,
    EMAIL VARCHAR2(100),
    MATKHAU VARCHAR2(100) NOT NULL,
    HOTEN VARCHAR2(100),
    LOAITK VARCHAR2(20) CHECK (LOAITK IN ('KHACHHANG', 'KHACHSAN', 'ADMIN'))
);

ALTER TABLE NGUOIDUNG
ADD CONSTRAINT uq_NGUOIDUNG_email UNIQUE (EMAIL);


-- 2. KHÁCH HÀNG
CREATE TABLE KHACHHANG (
    ID NUMBER PRIMARY KEY REFERENCES NGUOIDUNG(ID) ON DELETE CASCADE,
    CCCD VARCHAR2(20),
    NGAYSINH DATE
);

-- 3. KHÁCH SẠN (TRƯỚC ĐÂY LÀ DOANHNGHIEP)
CREATE TABLE KHACHSAN (
    ID NUMBER PRIMARY KEY REFERENCES NGUOIDUNG(ID) ON DELETE CASCADE,
    TENDN VARCHAR2(100),
    DIACHI VARCHAR2(200),
    TINH VARCHAR2(200),
    MOTA CLOB,
    STK varchar(100),
    BANK varchar(100)
);


-- 4. NHÂN VIÊN
CREATE TABLE NHANVIEN (
    ID NUMBER PRIMARY KEY REFERENCES NGUOIDUNG(ID) ON DELETE CASCADE,
    BOPHAN VARCHAR2(50)
);

-- 5. PHÒNG
CREATE TABLE PHONG (
    ID NUMBER PRIMARY KEY,
    KHACHSAN_ID NUMBER REFERENCES KHACHSAN(ID) ON DELETE CASCADE,
    LOAIPHONG VARCHAR2(50),
    GIA NUMBER,
    MOTA CLOB,
    TONGSOLUONG NUMBER,
    NGAY_DANG DATE,
    ANH1 BLOB,
    ANH2 BLOB,
    ANH3 BLOB,
);


-- 6. ĐẶT PHÒNG
CREATE TABLE DATPHONG (
    ID NUMBER PRIMARY KEY,
    KHACHHANG_ID NUMBER REFERENCES KHACHHANG(ID) ON DELETE CASCADE,
    PHONG_ID NUMBER REFERENCES PHONG(ID) ON DELETE CASCADE,
    NGAYNHAN DATE,
    NGAY_TRA DATE,
    NGAY_DAT DATE,
    SL NUMBER,
    DIEMDANHGIA NUMBER
);

-- 7. THANH TOÁN
CREATE TABLE THANHTOAN (
    ID NUMBER PRIMARY KEY, -- Tham chiếu tới ID của DATPHONG
    NGAY_GIAODICH DATE DEFAULT SYSDATE,
    SOTIEN NUMBER(10, 2),
    SOTHE VARCHAR2(4 BYTE), -- Lưu 4 số cuối
    TEN_CHUTHE VARCHAR2(50),
    TENTHE VARCHAR2(50),
    FOREIGN KEY (ID) REFERENCES DATPHONG(ID) ON DELETE CASCADE
);

-- 8. HỎI ĐÁP
CREATE TABLE HOIDAP (
    ID NUMBER PRIMARY KEY,
    KHACHHANG_ID NUMBER REFERENCES KHACHHANG(ID) ON DELETE CASCADE,
    NOIDUNG CLOB,
    NGAYGUI DATE DEFAULT SYSDATE,
    NHANVIEN_ID NUMBER REFERENCES NHANVIEN(ID) ON DELETE CASCADE,
    TRALOI CLOB,
    NGAYTRALOI DATE
);

--9. DON CHINH SUA
CREATE TABLE DON_CHINHSUA (
    ID               NUMBER PRIMARY KEY,
    DATPHONG_ID      NUMBER NOT NULL,
    NGAYNHAN_MOI     DATE,
    NGAY_TRA_MOI     DATE,
    SL_MOI           NUMBER,
    TRANGTHAI_DUYET  VARCHAR2(20),
    TRANGTHAI_THANHTOAN   VARCHAR(20), 
    CONSTRAINT FK_DATPHONG FOREIGN KEY (DATPHONG_ID) REFERENCES DATPHONG(ID) ON DELETE CASCADE
);

ALTER TABLE DON_CHINHSUA
ADD CONSTRAINT CK_TTDONCHINHSUA_DUYET CHECK (TRANGTHAI_DUYET IN ('CHỜ DUYỆT', 'ĐÃ DUYỆT', 'KHÔNG DUYỆT'));

ALTER TABLE DON_CHINHSUA
ADD CONSTRAINT CK_THANHTOAN CHECK (TRANGTHAI_THANHTOAN IN ('ĐÃ THANH TOÁN', 'CHƯA THANH TOÁN'));



-- ===================
-- SEQUENCE + TRIGGER

-- NGUOI DUNG
CREATE SEQUENCE SEQ_NGUOIDUNG_ID START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER TRG_AUTO_ID_NGUOIDUNG
BEFORE INSERT
ON NGUOIDUNG
FOR EACH ROW
BEGIN
  IF :NEW.ID IS NULL THEN
    SELECT SEQ_NGUOIDUNG_ID.NEXTVAL INTO :NEW.ID FROM dual;
  END IF;
END;
/

-- 1. Tạo sequence cho PHONG.ID
CREATE SEQUENCE seq_phong
START WITH 1
INCREMENT BY 1
NOCACHE
NOCYCLE;

-- 2. Tạo trigger tự động gán ID trước khi insert
CREATE OR REPLACE TRIGGER trg_phong_id
BEFORE INSERT
ON PHONG
FOR EACH ROW
BEGIN
  IF :NEW.ID IS NULL THEN
    :NEW.ID := seq_phong.NEXTVAL;
  END IF;
END;
/

--Thêm trigger tự dộng tăng id DATPHONG :
 -- 1. Tạo sequence
CREATE SEQUENCE seq_datphong
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 2. Tạo trigger BEFORE INSERT
CREATE OR REPLACE TRIGGER trg_datphong_bi
BEFORE INSERT
ON datphong
FOR EACH ROW
BEGIN
    IF :NEW.id IS NULL THEN
        SELECT seq_datphong.NEXTVAL INTO :NEW.id
        FROM DUAL;
    END IF;
END;
/


--TRIGGER ID CHO DON CHINH SUA
CREATE SEQUENCE SEQ_DONCHINHSUA START WITH 1 INCREMENT BY 1;

CREATE OR REPLACE TRIGGER trg_auto_id_donchinhsua
BEFORE INSERT ON DON_CHINHSUA
FOR EACH ROW
BEGIN
    SELECT SEQ_DONCHINHSUA.NEXTVAL INTO :NEW.ID
    FROM dual;
END;
/


CREATE OR REPLACE FUNCTION SO_PHONG_TRONG (v_phong_id IN NUMBER, v_ngay_nhan IN DATE, v_ngay_tra IN DATE)
RETURN NUMBER
IS
    v_tong_so_luong     NUMBER;
    v_da_dat            NUMBER;
    v_con_trong         NUMBER;
BEGIN
    -- Lấy tổng số lượng phòng từ bảng PHONG
    SELECT TONGSOLUONG INTO v_tong_so_luong
    FROM PHONG
    WHERE ID = v_phong_id;

    -- Tính tổng số lượng phòng đã được đặt trùng khoảng thời gian
    SELECT NVL(SUM(SL), 0) INTO v_da_dat
    FROM DATPHONG
    WHERE PHONG_ID=v_phong_id
    AND(
            (v_ngay_nhan<NGAY_TRA AND v_ngay_tra>NGAYNHAN)
        );

    -- Tính số phòng còn trống
    v_con_trong:=v_tong_so_luong-v_da_dat;

    RETURN v_con_trong;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 0;
    WHEN OTHERS THEN
        RETURN -1;
END;
/


-- Khách hàng
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK) VALUES (1, 'kh1@gmail.com', '123', 'Nguyễn Văn A', 'KHACHHANG');
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK) VALUES (2, 'kh2@gmail.com', '123', 'Trần Thị B', 'KHACHHANG');

-- Khách sạn (doanh nghiệp)
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK) VALUES (3, 'ks1@gmail.com', '123', 'Khách sạn Mặt Trời', 'KHACHSAN');
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK) VALUES (4, 'ks2@gmail.com', '123', 'Khách sạn Biển Xanh', 'KHACHSAN');

-- Nhân viên hệ thống
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK) VALUES (5, 'admin1', 'admin', 'Ngô Văn C', 'ADMIN');


INSERT INTO KHACHHANG (ID, CCCD, NGAYSINH) VALUES (1, '012345678901', TO_DATE('1995-05-15','YYYY-MM-DD'));
INSERT INTO KHACHHANG (ID, CCCD, NGAYSINH) VALUES (2, '012345678902', TO_DATE('1990-08-20','YYYY-MM-DD'));


INSERT INTO KHACHSAN (ID, TENDN, DIACHI, TINH, MOTA, STK, BANK) 
VALUES (3, 'matroi_hotel', '123 Đường A, Quận 1', 'TP.HCM', 'Khách sạn cao cấp trung tâm TP.HCM', '123456789', 'Vietcombank');

INSERT INTO KHACHSAN (ID, TENDN, DIACHI, TINH, MOTA, STK, BANK) 
VALUES (4, 'bienxanh_hotel', '456 Đường B, Quận 3', 'TP.HCM', 'Khách sạn gần biển với view đẹp', '987654321', 'ACB');


INSERT INTO NHANVIEN (ID, BOPHAN) VALUES (5, 'Quản trị hệ thống');
commit;

-- Khách sạn 1
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK)
VALUES (6, 'ks3@gmail.com', '123', 'Khách sạn Sông Hồng', 'KHACHSAN');

INSERT INTO KHACHSAN (ID, TENDN, DIACHI, TINH, MOTA, STK, BANK)
VALUES (6, 'songhonghotel', '12 Phố Huế, Hà Nội', 'Hà Nội', 'Khách sạn 3 sao gần trung tâm', '123456789', 'Vietcombank');

-- Khách sạn 2
INSERT INTO NGUOIDUNG (ID, EMAIL, MATKHAU, HOTEN, LOAITK)
VALUES (7, 'ks4@gmail.com', '123', 'Khách sạn Hồ Tây', 'KHACHSAN');

INSERT INTO KHACHSAN (ID, TENDN, DIACHI, TINH, MOTA, STK, BANK)
VALUES (7, 'hotayhotel', '88 Trích Sài, Hà Nội', 'Hà Nội', 'Khách sạn 4 sao cạnh hồ Tây', '987654321', 'Techcombank');
commit;


--10 phòng cho KS đầu tiên.
INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (1, 3, 'Deluxe City View', 1200000, 'Phòng rộng rãi, có ban công nhìn ra thành phố.', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (2, 3, 'Superior Double', 1050000, 'Phòng 2 người với nội thất sang trọng.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (3, 3, 'Standard', 900000, 'Phòng tiêu chuẩn với đầy đủ tiện nghi cơ bản.', 5, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (4, 3, 'Family Suite', 1800000, 'Phòng gia đình gồm 2 phòng ngủ và 1 phòng khách.', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (5, 3, 'Junior Suite', 1500000, 'Phòng có khu tiếp khách nhỏ, thích hợp cho công tác.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (6, 3, 'Twin Room', 950000, 'Phòng có 2 giường đơn, phù hợp cho bạn bè đi cùng.', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (7, 3, 'Single Room', 800000, 'Phòng đơn nhỏ gọn, giá cả phải chăng.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (8, 3, 'Presidential Suite', 3500000, 'Phòng tổng thống đẳng cấp, có hồ bơi riêng.', 1, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (9, 3, 'Studio Room', 1100000, 'Phòng dạng studio với bếp nhỏ tiện lợi.', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (10, 3, 'Connecting Room', 1700000, 'Hai phòng thông nhau, lý tưởng cho nhóm bạn.', 2, SYSDATE);


--10 phòng cho KS thứ hai
INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (11, 4, 'Ocean View Deluxe', 1400000, 'Phòng hướng biển, có ban công rộng.', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (12, 4, 'Beachfront Suite', 2200000, 'Phòng cao cấp sát bãi biển, đầy đủ tiện nghi.', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (13, 4, 'Garden View Room', 1000000, 'Phòng nhìn ra vườn, yên tĩnh và trong lành.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (14, 4, 'Penthouse', 3800000, 'Căn hộ cao cấp tầng thượng với view 360 độ.', 1, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (15, 4, 'Economy Room', 850000, 'Phòng tiết kiệm dành cho khách du lịch bụi.', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (16, 4, 'Couple Room', 1300000, 'Phòng đôi dành cho các cặp đôi nghỉ dưỡng.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (17, 4, 'Bungalow', 2000000, 'Phòng biệt lập dạng nhà gỗ sát biển.', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (18, 4, 'Triple Room', 1150000, 'Phòng 3 giường đơn, phù hợp cho nhóm.', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (19, 4, 'VIP Family Room', 1900000, 'Phòng gia đình cao cấp với không gian riêng.', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (20, 4, 'Pool Access Room', 1600000, 'Phòng có cửa ra hồ bơi trực tiếp.', 2, SYSDATE);

--10 phòng cho KS thứ ba
INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (601, 6, 'Standard Twin', 450000, 'Phòng 2 giường đơn, diện tích 25m2, có điều hòa', 5, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (602, 6, 'Standard Double', 500000, 'Phòng 1 giường đôi, gần cửa sổ, diện tích 25m2', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (603, 6, 'Superior', 550000, 'Phòng tiện nghi hơn, có tủ lạnh mini và bàn làm việc', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (604, 6, 'Deluxe', 600000, 'Phòng rộng rãi với view phố, giường lớn', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (605, 6, 'Family Room', 800000, 'Phòng gia đình 4 người, có sofa và bồn tắm', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (606, 6, 'Standard Single', 400000, 'Phòng đơn nhỏ gọn, tiết kiệm, phù hợp công tác', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (607, 6, 'Studio', 650000, 'Phòng có bếp nhỏ và bàn ăn, thích hợp ở lâu ngày', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (608, 6, 'Economy', 380000, 'Phòng cơ bản giá rẻ, diện tích nhỏ', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (609, 6, 'Deluxe Twin', 620000, '2 giường đơn, view đẹp, có tủ quần áo lớn', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (610, 6, 'Business Suite', 900000, 'Phòng cao cấp cho doanh nhân, bàn làm việc riêng', 1, SYSDATE);


--10 phòng cho KS thứ tư
INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (701, 7, 'Garden View', 700000, 'Phòng nhìn ra vườn, yên tĩnh, có ban công', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (702, 7, 'Lake View', 850000, 'Phòng view hồ Tây, có ghế thư giãn cạnh cửa sổ', 3, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (703, 7, 'Family Deluxe', 950000, 'Phòng rộng 45m2, giường lớn + sofa', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (704, 7, 'Presidential Suite', 1500000, 'Phòng VIP nhất resort, có bồn tắm, minibar và phòng khách', 1, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (705, 7, 'Couple Room', 800000, 'Phòng đôi lãng mạn, có đèn trang trí và rèm tự động', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (706, 7, 'Standard', 600000, 'Phòng tiêu chuẩn, nội thất gỗ sang trọng', 4, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (707, 7, 'Premium King', 1000000, 'Giường king size, TV 55 inch, phòng tắm kính', 2, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (708, 7, 'Studio Apartment', 1100000, 'Phòng kiểu căn hộ mini, có bếp và máy giặt', 1, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (709, 7, 'Executive', 1200000, 'Phòng dành cho quản lý cấp cao, bàn làm việc lớn', 1, SYSDATE);

INSERT INTO PHONG (ID, KHACHSAN_ID, LOAIPHONG, GIA, MOTA, TONGSOLUONG, NGAY_DANG)
VALUES (710, 7, 'Balcony View', 880000, 'Phòng có ban công lớn và bàn trà', 2, SYSDATE);

commit;